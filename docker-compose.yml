version: '3.8'

x-jwt-common: &jwt_common
  JWT_SECRET_KEY: ${JWT_SECRET_KEY}
  JWT_ALGORITHM: ${JWT_ALGORITHM:-HS256}
  ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
  REFRESH_TOKEN_EXPIRE_DAYS: ${REFRESH_TOKEN_EXPIRE_DAYS:-7}

services:
  # ==========================================
  # 0. API GATEWAY (Nginx Reverse Proxy)
  # ==========================================
  api-gateway:
    image: nginx:alpine
    container_name: api_gateway
    restart: always
    ports:
      - "8080:80"
    volumes:
      - ./gateway/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      submission-service:
        condition: service_started
      notification-service:
        condition: service_started
      conference-service:
        condition: service_started
      intelligent-service:
        condition: service_started
      review-service:
        condition: service_started
      identity-service:
        condition: service_started
    networks:
      - confms-network

  # ==========================================
  # 1. SUBMISSION SERVICE
  # ==========================================
  submission-db:
    image: mysql:8.0
    container_name: submission_db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: submission_db
    ports:
      - "3307:3306"
    volumes:
      - submission_db_data:/var/lib/mysql
    networks:
      - confms-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 15

  submission-service:
    build: ./backend/submission-service
    container_name: submission_service
    restart: on-failure
    ports:
      - "8000:8000"
    depends_on:
      submission-db:
        condition: service_healthy
      identity-service:
        condition: service_started
    env_file:
      - ./.env
      - ./backend/submission-service/.env
    environment:
      INTERNAL_KEY: ${INTERNAL_KEY}
      DATABASE_URL: mysql+pymysql://root:root@submission-db:3306/submission_db
      NOTIFICATION_SERVICE_URL: http://notification-service:8000/api/notifications
      REVIEW_SERVICE_URL: http://review-service:8000
      CONFERENCE_SERVICE_URL: http://conference-service:8000
      INTELLIGENT_SERVICE_URL: http://intelligent-service:8000
      IDENTITY_SERVICE_URL: http://identity-service:8000
      <<: *jwt_common
    volumes:
      - ./backend/submission-service/uploads:/app/uploads
    networks:
      - confms-network

  # ==========================================
  # 2. NOTIFICATION SERVICE
  # ==========================================
  notification-db:
    image: mysql:8.0
    container_name: notification_db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: notification_db
    ports:
      - "3308:3306"
    volumes:
      - notification_db_data:/var/lib/mysql
    networks:
      - confms-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 15

  notification-service:
    build: ./backend/notification-service
    container_name: notification_service
    restart: on-failure
    ports:
      - "8001:8000"
    depends_on:
      notification-db:
        condition: service_healthy
    env_file:
      - ./.env
      - ./backend/notification-service/.env
    environment:
      INTERNAL_KEY: ${INTERNAL_KEY}
      SECRET_KEY: ${JWT_SECRET_KEY}
      DATABASE_URL: mysql+pymysql://root:root@notification-db:3306/notification_db
      <<: *jwt_common
    networks:
      - confms-network

  # ==========================================
  # 3. CONFERENCE SERVICE
  # ==========================================
  conference-db:
    image: mysql:8.0
    container_name: conference_db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: conference_db
    ports:
      - "3309:3306"
    volumes:
      - conference_db_data:/var/lib/mysql
    networks:
      - confms-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 15

  conference-service:
    build:
      context: ./backend/conference-service
      dockerfile: Dockerfile
    container_name: conference_service
    restart: on-failure
    ports:
      - "8002:8000"
    depends_on:
      conference-db:
        condition: service_healthy
      identity-service:
        condition: service_started
    env_file:
      - ./.env
      - ./backend/conference-service/.env
    environment:
      DATABASE_URL: mysql+pymysql://root:root@conference-db:3306/conference_db
      SUBMISSION_SERVICE_URL: http://submission-service:8000
      NOTIFICATION_SERVICE_URL: http://notification-service:8000
      REVIEW_SERVICE_URL: http://review-service:8000
      INTELLIGENT_SERVICE_URL: http://intelligent-service:8000
      IDENTITY_SERVICE_URL: http://identity-service:8000
      <<: *jwt_common
    networks:
      - confms-network

  # ==========================================
  # 4. INTELLIGENT SERVICE (AI)
  # ==========================================
  intelligent-db:
    image: mysql:8.0
    container_name: intelligent_db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: intelligent_db
    ports:
      - "3310:3306"
    volumes:
      - intelligent_db_data:/var/lib/mysql
    networks:
      - confms-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 15

  intelligent-service:
    build: ./backend/intelligent-service
    container_name: intelligent_service
    restart: on-failure
    ports:
      - "8004:8000"
    depends_on:
      intelligent-db:
        condition: service_healthy
    env_file:
      - ./.env
      - ./backend/intelligent-service/.env
    environment:
      DATABASE_URL: mysql+pymysql://root:root@intelligent-db:3306/intelligent_db
      <<: *jwt_common
    # [QUAN TRỌNG] Tắt chế độ reload để tránh lỗi tràn RAM (Errno 12)
    command: uvicorn src.main:app --host 0.0.0.0 --port 8000
    volumes:
      - ./backend/intelligent-service/src:/app/src
    networks:
      - confms-network

  # ==========================================
  # 5. REVIEW SERVICE
  # ==========================================
  review-db:
    image: mysql:8.0
    container_name: review_db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: review_db
    ports:
      - "3311:3306"
    volumes:
      - review_db_data:/var/lib/mysql
    networks:
      - confms-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 15

  review-service:
    build: ./backend/review-service
    container_name: review_service
    restart: on-failure
    ports:
      - "8003:8000"
    depends_on:
      review-db:
        condition: service_healthy
      submission-service:
        condition: service_started
      conference-service:
        condition: service_started
      identity-service:
        condition: service_started
    env_file:
      - ./.env
      - ./backend/review-service/.env
    environment:
      DATABASE_URL: mysql+pymysql://root:root@review-db:3306/review_db
      SUBMISSION_SERVICE_URL: http://submission-service:8000
      NOTIFICATION_SERVICE_URL: http://notification-service:8000
      CONFERENCE_SERVICE_URL: http://conference-service:8000
      INTELLIGENT_SERVICE_URL: http://intelligent-service:8000
      IDENTITY_SERVICE_URL: http://identity-service:8000
      <<: *jwt_common
    networks:
      - confms-network

  # ==========================================
  # 6. IDENTITY SERVICE
  # ==========================================
  identity-db:
    image: mysql:8.0
    container_name: identity_db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: identity_db
    ports:
      - "3306:3306"
    volumes:
      - identity_db_data:/var/lib/mysql
    networks:
      - confms-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 15

  identity-service:
    build: ./backend/identity-service
    container_name: identity_service
    restart: on-failure
    depends_on:
      identity-db:
        condition: service_healthy
    ports:
      - "8005:8000"
    environment:
      DATABASE_URL: mysql+pymysql://root:root@identity-db:3306/identity_db
      SECRET_KEY: ${JWT_SECRET_KEY}
      ALGORITHM: ${JWT_ALGORITHM:-HS256}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      NOTIFICATION_SERVICE_URL: http://notification-service:8000
      INTERNAL_KEY: ${INTERNAL_KEY}
      
      SEED_ON_STARTUP: "true"
      ADMIN_EMAIL: admin@uth.edu.vn
      ADMIN_PASSWORD: 123456
      ADMIN_NAME: System Administrator
    networks:
      - confms-network

  # ==========================================
  # 7. FRONTEND
  # ==========================================
  frontend:
    build: ./frontend
    container_name: frontend_service
    restart: always
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      - REACT_APP_API_URL=http://localhost:8080
    networks:
      - confms-network

# ==========================================
# VOLUMES & NETWORKS
# ==========================================
volumes:
  submission_db_data:
  notification_db_data:
  conference_db_data:
  intelligent_db_data:
  review_db_data:
  identity_db_data:

networks:
  confms-network:
    driver: bridge