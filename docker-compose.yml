version: '3.8'

x-jwt-common: &jwt_common
  JWT_SECRET_KEY: ${JWT_SECRET_KEY}
  JWT_ALGORITHM: ${JWT_ALGORITHM:-HS256}
  ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
  REFRESH_TOKEN_EXPIRE_DAYS: ${REFRESH_TOKEN_EXPIRE_DAYS:-7}

services:
  # ==========================================
  # 0. API GATEWAY
  # ==========================================
  api-gateway:
    image: nginx:alpine
    container_name: api_gateway
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - ./gateway/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      submission-service:
        condition: service_healthy
      notification-service:
        condition: service_healthy
      conference-service:
        condition: service_healthy
      intelligent-service:
        condition: service_healthy
      review-service:
        condition: service_healthy
      identity-service:
        condition: service_healthy
    networks:
      - confms-network

  # ==========================================
  # 0.5. INFRASTRUCTURE (REDIS & RABBITMQ)
  # ==========================================
  redis:
    image: redis:7-alpine
    container_name: confms_redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    networks:
      - confms-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 15

  # GIỮ LẠI RABBITMQ ĐỂ GỬI MAIL
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: confms_rabbitmq
    restart: unless-stopped
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    networks:
      - confms-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ==========================================
  # 1. SUBMISSION SERVICE & WORKER
  # ==========================================
  submission-db:
    image: mysql:8.0
    container_name: submission_db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: submission_db
    ports:
      - "3307:3306"
    volumes:
      - submission_db_data:/var/lib/mysql
    networks:
      - confms-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 15

  submission-service:
    build: ./backend/submission-service
    container_name: submission_service
    restart: unless-stopped
    ports:
      - "8000:8000"
    depends_on:
      submission-db:
        condition: service_healthy
      identity-service:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    env_file:
      - ./.env
      - ./backend/submission-service/.env
    environment:
      INTERNAL_KEY: ${INTERNAL_KEY}
      DATABASE_URL: mysql+pymysql://root:root@submission-db:3306/submission_db
      NOTIFICATION_SERVICE_URL: http://notification-service:8000/api/notifications
      REVIEW_SERVICE_URL: http://review-service:8000
      CONFERENCE_SERVICE_URL: http://conference-service:8000
      INTELLIGENT_SERVICE_URL: http://intelligent-service:8000
      IDENTITY_SERVICE_URL: http://identity-service:8000
      # Cấu hình RabbitMQ
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      CACHE_TYPE: redis
      REDIS_URL: redis://redis:6379/0
      CACHE_PREFIX: submission-service
      CACHE_DEFAULT_TTL: ${CACHE_DEFAULT_TTL:-300}
      <<: *jwt_common
    volumes:
      - ./backend/submission-service/uploads:/app/uploads
      - ./backend/submission-service/src:/app/src
    networks:
      - confms-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/openapi.json').read()\" >/dev/null 2>&1 || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 20s

  # WORKER SERVICE (Vẫn giữ để gửi Email)
  worker-service:
    build: ./backend/submission-service
    container_name: worker_service
    restart: unless-stopped
    command: python -u src/worker.py
    depends_on:
      rabbitmq:
        condition: service_healthy
      submission-db:
        condition: service_healthy
    env_file:
      - ./.env
      - ./backend/submission-service/.env
    environment:
      DATABASE_URL: mysql+pymysql://root:root@submission-db:3306/submission_db
      RABBITMQ_HOST: rabbitmq
    volumes:
      - ./backend/submission-service/uploads:/app/uploads
      - ./backend/submission-service/src:/app/src
    networks:
      - confms-network

  # ==========================================
  # 2. NOTIFICATION SERVICE
  # ==========================================
  notification-db:
    image: mysql:8.0
    container_name: notification_db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: notification_db
    ports:
      - "3308:3306"
    volumes:
      - notification_db_data:/var/lib/mysql
    networks:
      - confms-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 15

  notification-service:
    build: ./backend/notification-service
    container_name: notification_service
    restart: unless-stopped
    ports:
      - "8001:8000"
    depends_on:
      notification-db:
        condition: service_healthy
      redis:
        condition: service_healthy
    env_file:
      - ./.env
      - ./backend/notification-service/.env
    environment:
      INTERNAL_KEY: ${INTERNAL_KEY}
      SECRET_KEY: ${JWT_SECRET_KEY}
      DATABASE_URL: mysql+pymysql://root:root@notification-db:3306/notification_db
      CONFERENCE_SERVICE_URL: http://conference-service:8000
      CACHE_TYPE: redis
      REDIS_URL: redis://redis:6379/0
      CACHE_PREFIX: notification-service
      CACHE_DEFAULT_TTL: ${CACHE_DEFAULT_TTL:-300}
      <<: *jwt_common
    volumes:
      - ./backend/notification-service/serviceAccountKey.json:/app/serviceAccountKey.json
    networks:
      - confms-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/openapi.json').read()\" >/dev/null 2>&1 || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 20s

  # ==========================================
  # 3. CONFERENCE SERVICE
  # ==========================================
  conference-db:
    image: mysql:8.0
    container_name: conference_db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: conference_db
    ports:
      - "3309:3306"
    volumes:
      - conference_db_data:/var/lib/mysql
    networks:
      - confms-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 15

  conference-service:
    build:
      context: ./backend/conference-service
      dockerfile: Dockerfile
    container_name: conference_service
    restart: unless-stopped
    ports:
      - "8002:8000"
    volumes:
      - ./backend/conference-service/src/static:/app/src/static
    depends_on:
      conference-db:
        condition: service_healthy
      identity-service:
        condition: service_healthy
      redis:
        condition: service_healthy
    env_file:
      - ./.env
      - ./backend/conference-service/.env
    environment:
      DATABASE_URL: mysql+pymysql://root:root@conference-db:3306/conference_db
      SUBMISSION_SERVICE_URL: http://submission-service:8000
      NOTIFICATION_SERVICE_URL: http://notification-service:8000
      REVIEW_SERVICE_URL: http://review-service:8000
      INTELLIGENT_SERVICE_URL: http://intelligent-service:8000
      IDENTITY_SERVICE_URL: http://identity-service:8000
      CACHE_TYPE: redis
      REDIS_URL: redis://redis:6379/0
      CACHE_PREFIX: conference-service
      CACHE_DEFAULT_TTL: 300
      <<: *jwt_common
    networks:
      - confms-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/openapi.json').read()\" >/dev/null 2>&1 || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 20s

  # ==========================================
  # 4. INTELLIGENT SERVICE (AI)
  # ==========================================
  intelligent-db:
    image: mysql:8.0
    container_name: intelligent_db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: intelligent_db
    ports:
      - "3310:3306"
    volumes:
      - intelligent_db_data:/var/lib/mysql
    networks:
      - confms-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 15

  intelligent-service:
    build: ./backend/intelligent-service
    container_name: intelligent_service
    restart: unless-stopped
    ports:
      - "8004:8000"
    depends_on:
      intelligent-db:
        condition: service_healthy
      redis:
        condition: service_healthy
    env_file:
      - ./.env
      - ./backend/intelligent-service/.env
    environment:
      DATABASE_URL: mysql+pymysql://root:root@intelligent-db:3306/intelligent_db
      PYTHONUNBUFFERED: "1"
      CACHE_TYPE: redis
      REDIS_URL: redis://redis:6379/0
      CACHE_PREFIX: intelligent-service
      CACHE_DEFAULT_TTL: ${CACHE_DEFAULT_TTL:-300}
      <<: *jwt_common
    command: uvicorn src.main:app --host 0.0.0.0 --port 8000
    volumes:
      - ./backend/intelligent-service/src:/app/src
    networks:
      - confms-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/openapi.json').read()\" >/dev/null 2>&1 || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 20s

  # ==========================================
  # 5. REVIEW SERVICE
  # ==========================================
  review-db:
    image: mysql:8.0
    container_name: review_db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: review_db
    ports:
      - "3311:3306"
    volumes:
      - review_db_data:/var/lib/mysql
    networks:
      - confms-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 15

  review-service:
    build: ./backend/review-service
    container_name: review_service
    restart: unless-stopped
    ports:
      - "8003:8000"
    depends_on:
      review-db:
        condition: service_healthy
      submission-service:
        condition: service_healthy
      conference-service:
        condition: service_healthy
      identity-service:
        condition: service_healthy
      redis:
        condition: service_healthy
    env_file:
      - ./.env
      - ./backend/review-service/.env
    environment:
      DATABASE_URL: mysql+pymysql://root:root@review-db:3306/review_db
      SUBMISSION_SERVICE_URL: http://submission-service:8000
      NOTIFICATION_SERVICE_URL: http://notification-service:8000
      CONFERENCE_SERVICE_URL: http://conference-service:8000
      INTELLIGENT_SERVICE_URL: http://intelligent-service:8000
      IDENTITY_SERVICE_URL: http://identity-service:8000
      CACHE_TYPE: redis
      REDIS_URL: redis://redis:6379/0
      CACHE_PREFIX: review-service
      CACHE_DEFAULT_TTL: ${CACHE_DEFAULT_TTL:-300}
      <<: *jwt_common
    networks:
      - confms-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/openapi.json').read()\" >/dev/null 2>&1 || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 20s

  # ==========================================
  # 6. IDENTITY SERVICE
  # ==========================================
  identity-db:
    image: mysql:8.0
    container_name: identity_db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: identity_db
    ports:
      - "3306:3306"
    volumes:
      - identity_db_data:/var/lib/mysql
    networks:
      - confms-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 15

  identity-service:
    build: ./backend/identity-service
    container_name: identity_service
    restart: unless-stopped
    depends_on:
      identity-db:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "8005:8000"
    environment:
      DATABASE_URL: mysql+pymysql://root:root@identity-db:3306/identity_db
      SECRET_KEY: ${JWT_SECRET_KEY}
      ALGORITHM: ${JWT_ALGORITHM:-HS256}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      NOTIFICATION_SERVICE_URL: http://notification-service:8000
      INTERNAL_KEY: ${INTERNAL_KEY}
      SEED_ON_STARTUP: "true"
      ADMIN_EMAIL: admin@uth.edu.vn
      ADMIN_PASSWORD: 123456
      ADMIN_NAME: System Administrator
      CACHE_TYPE: redis
      REDIS_URL: redis://redis:6379/0
      CACHE_PREFIX: identity-service
      CACHE_DEFAULT_TTL: ${CACHE_DEFAULT_TTL:-300}
      <<: *jwt_common
    networks:
      - confms-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/openapi.json').read()\" >/dev/null 2>&1 || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 20s

  # ==========================================
  # 7. FRONTEND
  # ==========================================
  frontend:
    build: ./frontend
    container_name: frontend_service
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_API_URL=http://localhost:8080
    networks:
      - confms-network

  # ==========================================
  # 8. MONITORING STACK
  # ==========================================
  prometheus:
    image: prom/prometheus:latest
    container_name: confms_prometheus
    restart: unless-stopped
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    networks:
      - confms-network

  grafana:
    image: grafana/grafana:latest
    container_name: confms_grafana
    restart: unless-stopped
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    depends_on:
      - prometheus
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - confms-network

volumes:
  submission_db_data:
  notification_db_data:
  conference_db_data:
  intelligent_db_data:
  review_db_data:
  identity_db_data:
  grafana_data:

networks:
  confms-network:
    driver: bridge