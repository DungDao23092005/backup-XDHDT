server {
  listen 80;
  proxy_hide_header Access-Control-Allow-Origin;
  proxy_hide_header Access-Control-Allow-Methods;
  proxy_hide_header Access-Control-Allow-Headers;
  proxy_hide_header Access-Control-Allow-Credentials;

   # ===== FIX: tránh duplicate CORS từ backend =====
  proxy_hide_header Access-Control-Allow-Origin;
  proxy_hide_header Access-Control-Allow-Methods;
  proxy_hide_header Access-Control-Allow-Headers;
  proxy_hide_header Access-Control-Allow-Credentials;
  proxy_hide_header Access-Control-Expose-Headers;

  # ===== CORS: chỉ set 1 lần tại gateway =====
  add_header Access-Control-Allow-Origin "http://localhost:3000" always;
  add_header Vary Origin always;
  add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
  add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Request-Id" always;
  add_header Access-Control-Allow-Credentials "true" always;

  if ($request_method = OPTIONS) { return 204; }

  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Port  $server_port;
  location = /identity/openapi.json {
    proxy_pass http://identity-service:8000/openapi.json;
  }

  location = /identity/docs {
    proxy_pass http://identity-service:8000/docs;

    sub_filter_once off;
    sub_filter_types text/html application/javascript;
    sub_filter '"/openapi.json"' '"/identity/openapi.json"';
    sub_filter "'/openapi.json'" "'/identity/openapi.json'";
  }

  location /identity/ {
    proxy_pass http://identity-service:8000/;
    proxy_set_header Authorization $http_authorization;
    proxy_redirect ~^http(s)?://[^/]+/(.*)$ http://$host:8080/identity/$1;
  }

  location = /conference/openapi.json {
    proxy_pass http://conference-service:8000/openapi.json;
  }

  location = /conference/docs {
    proxy_pass http://conference-service:8000/docs;

    sub_filter_once off;
    sub_filter_types text/html application/javascript;
    sub_filter '"/openapi.json"' '"/conference/openapi.json"';
    sub_filter "'/openapi.json'" "'/conference/openapi.json'";
  }

  location /conference/ {
    proxy_pass http://conference-service:8000/;
    proxy_set_header Authorization $http_authorization;

    proxy_redirect ~^http(s)?://[^/]+/(.*)$ http://$host:8080/conference/$1;
  }

  location = /submission/openapi.json {
    proxy_pass http://submission-service:8000/openapi.json;
  }

  location = /submission/docs {
    proxy_pass http://submission-service:8000/docs;

    sub_filter_once off;
    sub_filter_types text/html application/javascript;
    sub_filter '"/openapi.json"' '"/submission/openapi.json"';
    sub_filter "'/openapi.json'" "'/submission/openapi.json'";
  }

  location /submission/ {
    proxy_pass http://submission-service:8000/;
    proxy_set_header Authorization $http_authorization;

    proxy_redirect ~^http(s)?://[^/]+/(.*)$ http://$host:8080/submission/$1;
  }

  location = /review/openapi.json {
    proxy_pass http://review-service:8000/openapi.json;
  }

  location = /review/docs {
    proxy_pass http://review-service:8000/docs;

    sub_filter_once off;
    sub_filter_types text/html application/javascript;
    sub_filter '"/openapi.json"' '"/review/openapi.json"';
    sub_filter "'/openapi.json'" "'/review/openapi.json'";
  }

  location /review/ {
    proxy_pass http://review-service:8000/;
    proxy_set_header Authorization $http_authorization;

    proxy_redirect ~^http(s)?://[^/]+/(.*)$ http://$host:8080/review/$1;
  }

  location = /notification/openapi.json {
    proxy_pass http://notification-service:8000/openapi.json;
  }

  location = /notification/docs {
    proxy_pass http://notification-service:8000/docs;

    sub_filter_once off;
    sub_filter_types text/html application/javascript;
    sub_filter '"/openapi.json"' '"/notification/openapi.json"';
    sub_filter "'/openapi.json'" "'/notification/openapi.json'";
  }

  location /notification/ {
    proxy_pass http://notification-service:8000/;
    proxy_set_header Authorization $http_authorization;

    proxy_redirect ~^http(s)?://[^/]+/(.*)$ http://$host:8080/notification/$1;
  }

  location = /intelligent/openapi.json {
    proxy_pass http://intelligent-service:8000/openapi.json;
  }

  location = /intelligent/docs {
    proxy_pass http://intelligent-service:8000/docs;

    sub_filter_once off;
    sub_filter_types text/html application/javascript;
    sub_filter '"/openapi.json"' '"/intelligent/openapi.json"';
    sub_filter "'/openapi.json'" "'/intelligent/openapi.json'";
  }

  location /intelligent/ {
    proxy_pass http://intelligent-service:8000/;
    proxy_set_header Authorization $http_authorization;

    proxy_redirect ~^http(s)?://[^/]+/(.*)$ http://$host:8080/intelligent/$1;
  }
}
