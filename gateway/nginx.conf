server {
    listen 80;
    
    # Cho phép upload file to (20MB) cho Submission Service
    client_max_body_size 20m; 

    # ===== CORS CONFIGURATION (GLOBAL) =====
    # Ẩn header CORS từ Backend gửi lên để tránh bị trùng lặp
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Methods;
    proxy_hide_header Access-Control-Allow-Headers;
    proxy_hide_header Access-Control-Allow-Credentials;
    proxy_hide_header Access-Control-Expose-Headers;

    # Tự set header CORS tại Gateway
    add_header Access-Control-Allow-Origin "$http_origin" always;
    add_header Vary Origin always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Request-Id" always;
    add_header Access-Control-Allow-Credentials "true" always;

    # Xử lý Preflight Request (OPTIONS)
    if ($request_method = OPTIONS) { 
        return 204; 
    }

    # Header chung cho tất cả request proxy
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Port  $server_port;

    # =================================================
    # 1. FRONTEND (Trỏ về ReactJS) - QUAN TRỌNG
    # =================================================
    location / {
        proxy_pass http://frontend:3000;
        
        # Cấu hình WebSocket cho React Hot Reload
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # =================================================
    # 2. IDENTITY SERVICE
    # =================================================
    location = /identity/openapi.json {
        proxy_pass http://identity-service:8000/openapi.json;
    }
    location = /identity/docs {
        proxy_pass http://identity-service:8000/docs;
        sub_filter_once off;
        sub_filter_types text/html application/javascript;
        sub_filter '"/openapi.json"' '"/identity/openapi.json"';
        sub_filter "'/openapi.json'" "'/identity/openapi.json'";
    }
    location /identity/ {
        proxy_pass http://identity-service:8000/;
        proxy_set_header Authorization $http_authorization;
        proxy_redirect ~^http(s)?://[^/]+/(.*)$ http://$host:8080/identity/$1;
    }

    # =================================================
    # 3. CONFERENCE SERVICE
    # =================================================
    location = /conference/openapi.json {
        proxy_pass http://conference-service:8000/openapi.json;
    }
    location = /conference/docs {
        proxy_pass http://conference-service:8000/docs;
        sub_filter_once off;
        sub_filter_types text/html application/javascript;
        sub_filter '"/openapi.json"' '"/conference/openapi.json"';
        sub_filter "'/openapi.json'" "'/conference/openapi.json'";
    }
    location /conference/ {
        proxy_pass http://conference-service:8000/;
        proxy_set_header Authorization $http_authorization;
        proxy_redirect ~^http(s)?://[^/]+/(.*)$ http://$host:8080/conference/$1;
    }

    # =================================================
    # 4. SUBMISSION SERVICE (Upload PDF)
    # =================================================
    location = /submission/openapi.json {
        proxy_pass http://submission-service:8000/openapi.json;
    }
    location = /submission/docs {
        proxy_pass http://submission-service:8000/docs;
        sub_filter_once off;
        sub_filter_types text/html application/javascript;
        sub_filter '"/openapi.json"' '"/submission/openapi.json"';
        sub_filter "'/openapi.json'" "'/submission/openapi.json'";
    }
    location /submission/ {
        proxy_pass http://submission-service:8000/;
        proxy_set_header Authorization $http_authorization;
        # Quan trọng: Đảm bảo upload file to được đi qua
        client_max_body_size 20m; 
        proxy_redirect ~^http(s)?://[^/]+/(.*)$ http://$host:8080/submission/$1;
    }

    # =================================================
    # 5. REVIEW SERVICE
    # =================================================
    location = /review/openapi.json {
        proxy_pass http://review-service:8000/openapi.json;
    }
    location = /review/docs {
        proxy_pass http://review-service:8000/docs;
        sub_filter_once off;
        sub_filter_types text/html application/javascript;
        sub_filter '"/openapi.json"' '"/review/openapi.json"';
        sub_filter "'/openapi.json'" "'/review/openapi.json'";
    }
    location /review/ {
        proxy_pass http://review-service:8000/;
        proxy_set_header Authorization $http_authorization;
        proxy_redirect ~^http(s)?://[^/]+/(.*)$ http://$host:8080/review/$1;
    }

    # =================================================
    # 6. NOTIFICATION SERVICE
    # =================================================
    location = /notification/openapi.json {
        proxy_pass http://notification-service:8000/openapi.json;
    }
    location = /notification/docs {
        proxy_pass http://notification-service:8000/docs;
        sub_filter_once off;
        sub_filter_types text/html application/javascript;
        sub_filter '"/openapi.json"' '"/notification/openapi.json"';
        sub_filter "'/openapi.json'" "'/notification/openapi.json'";
    }
    location /notification/ {
        proxy_pass http://notification-service:8000/;
        proxy_set_header Authorization $http_authorization;
        proxy_redirect ~^http(s)?://[^/]+/(.*)$ http://$host:8080/notification/$1;
    }

    # =================================================
    # 7. INTELLIGENT SERVICE
    # =================================================
    location = /intelligent/openapi.json {
        proxy_pass http://intelligent-service:8000/openapi.json;
    }
    location = /intelligent/docs {
        proxy_pass http://intelligent-service:8000/docs;
        sub_filter_once off;
        sub_filter_types text/html application/javascript;
        sub_filter '"/openapi.json"' '"/intelligent/openapi.json"';
        sub_filter "'/openapi.json'" "'/intelligent/openapi.json'";
    }
    location /intelligent/ {
        proxy_pass http://intelligent-service:8000/;
        proxy_set_header Authorization $http_authorization;
        proxy_redirect ~^http(s)?://[^/]+/(.*)$ http://$host:8080/intelligent/$1;
    }
}